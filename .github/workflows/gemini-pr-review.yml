name: Gemini PR Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Get PR diff
      id: diff
      run: |
        git fetch origin ${{ github.base_ref }}
        git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install @google/generative-ai
      
    - name: Gemini Code Review
      uses: actions/github-script@v7
      env:
        GOOGLE_GEMINI_API_KEY: ${{ secrets.GOOGLE_GEMINI_API_KEY }}
      with:
        script: |
          const { GoogleGenerativeAI } = require('@google/generative-ai');
          const fs = require('fs');
          
          const genAI = new GoogleGenerativeAI(process.env.GOOGLE_GEMINI_API_KEY);
          const model = genAI.getGenerativeModel({ model: 'gemini-1.5-pro' });
          
          // Read the diff
          const diff = fs.readFileSync('pr_diff.txt', 'utf8');
          
          // Get PR details
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          // Request Gemini review
          const prompt = `Please review this pull request code changes. Focus on:
          
          1. Code quality and best practices
          2. Potential bugs or issues
          3. Security concerns
          4. Performance improvements
          5. Code maintainability
          
          PR Title: ${pr.title}
          PR Description: ${pr.body || 'No description provided'}
          
          Code Changes:
          \`\`\`diff
          ${diff}
          \`\`\`
          
          Provide a structured review with specific line references where applicable.`;
          
          const result = await model.generateContent(prompt);
          const review = result.response.text();
          
          // Post review as comment
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `## ðŸ¤– Gemini AI Code Review\n\n${review}\n\n---\n*Review generated by Google Gemini 1.5 Pro*`
          });
